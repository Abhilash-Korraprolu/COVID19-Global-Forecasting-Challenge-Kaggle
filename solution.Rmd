---
title: "COVID-19 Global Forecasting (Kaggle Competition)"
output: github_document
---

```{r setup, include=FALSE}
rm(list= ls())
knitr::opts_chunk$set(echo = TRUE)
library(tseries)
library(forecast)
library(dplyr)
```


```{r}
# Reading data
train<- read.csv('train.csv', stringsAsFactors= FALSE)
test<- read.csv('test.csv', stringsAsFactors= FALSE)

train$Date<- as.Date(train$Date)
test$Date<- as.Date(test$Date)
train$Id= NULL

head(train)
```

Some countries require forecasting for the whole while others such as Austraila need forcasting for its states and not as a whole.
```{r}
# Taking Sweden as an example country to try ARIMA on.
sweden= train[ train$Country_Region== 'Sweden', ]
sweden$weekday <- weekdays(sweden$Date)

# Confirmed Cases in Sweden
with(sweden,plot(Date, ConfirmedCases , type= 'l'))
```
```{r}
# Fatalities in Sweden
with(sweden,plot(Date, Fatalities , type= 'l'))
```

Since the count is cumulative, the trend is exponential in nature.

```{r}
# ARIMA Model Building
#1. For Confirmed Cases
ts_cc<- ts(sweden$ConfirmedCases, frequency= 365)
ARIMA_cc<- auto.arima(ts_cc, approximation= F) 
ARIMA_cc
```
```{r}
#2. For Fatalities
ts_f<- ts(sweden$Fatalities, frequency= 365)
ARIMA_f<- auto.arima(ts_f, approximation= F) 
ARIMA_f
```
Residual Analysis

1. ACF & PACF
```{r}
# Confirmed cases
par(mfrow=c(1,2)) 
acf(as.numeric(ARIMA_cc$residuals) , lag.max = 20, main= "Residuals ACF plot") 
pacf(as.numeric(ARIMA_cc$residuals), lag.max = 20, main= "Residuals PACF plot")
```
```{r}
# Fatalities
par(mfrow=c(1,2)) 
acf(as.numeric(ARIMA_f$residuals), lag.max = 20, main= "Residuals ACF plot") 
pacf(as.numeric(ARIMA_f$residuals), lag.max = 20, main= "Residuals PACF plot")
```

There is some valueable information at 5th lag. Overall it is quite good with some room for improvement.

Box-Ljung Test
```{r}
# Confirmed Cases
Box.test(ARIMA_cc$residuals,lag= 20, type= "Ljung-Box")
```
```{r}
# Fatalities
Box.test(ARIMA_f$residuals,lag= 20, type= "Ljung-Box")
```
The probability that the residuals are random is quite high. Again, there is room for improvement.


Forecasting
```{r}
# Confirmed cases
forecast_cc <- forecast(ARIMA_cc, h= 12)
plot(forecast_cc, shadecols= "oldstyle")
```
```{r}
# Fatalities
forecast_f <- forecast(ARIMA_f, h= 12)
plot(forecast_f, shadecols= "oldstyle")
```

Since the forecasting is for over 100 countries and is per state for some countries, we automate this process.
```{r warning= FALSE}
# Solving empty values in 'province_state' column
train$Province_State<- ifelse(train$Province_State== "", paste("All", train$Country_Region ), train$Province_State)
test$Province_State<- ifelse(test$Province_State== "", paste("All", test$Country_Region ), test$Province_State)

# Creating submission df
submission<- data.frame(ForecastId=numeric(0), ConfirmedCases=numeric(0),Fatalities=numeric(0))

for (s in unique(test$Province_State)){

  # Gathering data
  trainState<- train[train$Province_State== s, ]
  testDates<- test[test$Province_State== s, 'Date' ]
  forecastStartDate<- last(trainState$Date) + 1
  forecastEndDate<- last(testDates)
  numberOfDaysToForecast<- as.numeric((forecastEndDate+1) - forecastStartDate)

  # Model building and forecasting
  # 1. Confirmed Cases
  tsObjConfirmedCases<- ts(trainState$ConfirmedCases, frequency = 365)
  arimaModelConfirmedCases<- auto.arima(tsObjConfirmedCases, ic='aic', approximation = F) 
  forecastConfirmedCases<- forecast(arimaModelConfirmedCases, h= numberOfDaysToForecast)
  # 2. Fatalities
  tsObjFatalities<- ts(trainState$Fatalities, frequency = 365)
  arimaModelFatalities<- auto.arima(tsObjFatalities, ic='aic', approximation = F) 
  forecastFatalities<- forecast(arimaModelFatalities, h= numberOfDaysToForecast)
  
  # Creating submission data
  predictionsTrainState<- data.frame(Date= trainState$Date , ConfirmedCases= fitted(arimaModelConfirmedCases), Fatalities= fitted(arimaModelFatalities)) 
  forecastTestState<- data.frame(Date= seq(forecastStartDate, forecastEndDate, by="days") , ConfirmedCases= forecastConfirmedCases$mean, Fatalities= forecastFatalities$mean) 
  allPredictionsAndForecasts<- bind_rows(predictionsTrainState, forecastTestState)
  requiredPredictionsAndForecasts<- allPredictionsAndForecasts[ (allPredictionsAndForecasts$Date >= first(testDates)) & (allPredictionsAndForecasts$Date<= last(testDates)), c('ConfirmedCases', 'Fatalities') ]
  requiredPredictionsAndForecasts<- data.frame(ForecastId= test[test$Province_State== s, 'ForecastId' ], requiredPredictionsAndForecasts) 
  
  # Add predictions to final submission file
  submission<- rbind(submission, requiredPredictionsAndForecasts)
}
```

```{r}
head(submission)
```
